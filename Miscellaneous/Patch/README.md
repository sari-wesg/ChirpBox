# Patch

Provide a method for patching files on embedded devices without filesystem. Diff file is generated by [JojoDiff](http://jojodiff.sourceforge.net/), and the implementation on the embedded device is based on [Janpatch](https://github.com/janjongboom/janpatch) and STM32 HAL library. For easy verification locally, we support Ymodem file transmission from PC to device for downloading source file and diff file.

## Diff file

- Generate diff file using JojoDiff (under Windows)
  - Open a Windows command line
  - Change to the ``\JojoDiff\win32`` directory's path 
  ```
  jdiff Source.bin New.bin patch.bin
  ```

## Usage (library)

- Open ``/library/Src``, add ``flash_if.c`` and ``menu.c`` in the project.

- Define ``UART_Handle`` and ``CRC_Handle`` in ``menu.h``
  ```
  extern UART_HandleTypeDef huart2;
  extern CRC_HandleTypeDef CrcHandle;

  #define UART_Handle       huart2
  #define CRC_Handle        CrcHandle
  ```
- Download the source file and diff file in flash at defined place (here, we use page 10 and page 15 respectively) through Ymodem.
  ```
  // Prepare for download files
  menu_preSend();
  // download source file at page 10
  uint32_t original_size = menu_serialDownload(10);
  // download patch file at page 15
  uint32_t patch_size = menu_serialDownload(15);
  ```
- Patch the new file in flash.
  ```
  // patch the new file at page 20
  Filepatch(10, original_size, 15, patch_size, 20)
  ```

## Usage (project example)

- This is an implementation project on STM32L476.